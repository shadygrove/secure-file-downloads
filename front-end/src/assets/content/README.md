# File Download w/ Auth

## Problem
Authenticated file downloads are tricky to implement

Providing a direct link to file does not provide the ability to pass an auth token along with the request

## Summary
Possible solutions to authenticate file downloads are:  
* Front-end: Browser-based download using AJAX (not ideal for large files)  
* Front-end: Browser-based download using a[download] (cannot be authenticated other than w/ backend one-time-use token)
* Back-end: one-time-use token generated by server passed as query parameter to download URL.  Download link is not authenticated but the one-time-use token is verified and expires in a short period of time. [Cryptographic nonce](https://en.wikipedia.org/wiki/Cryptographic_nonce)
* Javascript Service Worker to stream file directly to user's file system
* [Angular Service Worker](https://angular.io/guide/service-worker-intro) ]

## Solution 1: Front-end Browser-based Download using AJAX
There is a way to make the request via Javascript and launch a save dialog without redirecting the user.  This would allow passing the token in the request headers.

### Concerns

This solution downloads the entire Blob into browser memory which may be problematic for large files.

Blob size limits vary by browser (Chrome = 2G; [more info](https://bugs.chromium.org/p/chromium/issues/detail?id=375297#c107)).  [See chart here](https://github.com/eligrey/FileSaver.js#supported-browsers).

### Resources/Examples:

[Angular File Download with Progress](https://nils-mehlhorn.de/posts/angular-file-download-progress):  
- uses a `download` RxJS operator from library `ngx-operators`  
- file save with [FileSaver.js](https://github.com/eligrey/FileSaver.js) library
- Working [example on StackBlitz](https://stackblitz.com/edit/angular-file-download-progress)  

> FileSaver.js recommends [StreamSaver.js](https://github.com/jimmywarting/StreamSaver.js) for large file downloads using Streams API

The FileSaver docs have an excellent summary file download solutions
[FileSaver.js](https://github.com/eligrey/FileSaver.js/wiki/Saving-a-remote-file)  

## Solution 2: Service Worker
A service worker can be used to directly download the file to the client.  The token can be passed to the service worker or it can access it directly from localStorage.

Since the Service Worker has elevated access to the user's file system and can write the file stream to disk at it arrives from the backend.

The [StreamSaver.js](https://github.com/jimmywarting/StreamSaver.js) library is designed to perform the download using a Service Worker.

Concerns:
Might be a little more complicated to setup.

Resources/Examples:
[StreamSaver.js Doc](https://github.com/jimmywarting/StreamSaver.js)
[Web Workers vs Service Workers vs Worklets](https://bitsofco.de/web-workers-vs-service-workers-vs-worklets/)  
